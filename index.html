<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Center - Sistema Pedidos</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header class="main-header no-print">
        <div class="logo">MOLLE PIZZA</div>
        <div class="header-controls">
            <label>Sede:</label>
            <select id="sedeSelector" class="btn-sede">
                <option value="buga">Buga</option>
                <option value="salomia">Salomia</option>
                <option value="granada">Granada</option>
                <option value="limonar">Limonar</option>
                <option value="san fernando">San Fernando</option>
                <option value="jamundi">Jamundí</option>
            </select>
        </div>
    </header>

    <div class="app-container">
        <section class="menu-panel no-print">
            <nav class="categories" id="categoryNav"></nav>
        
            <div class="content-area">
            <div id="search-wrapper"></div> <div id="productGrid" class="product-grid"></div>
        </div>
    </section>

        <aside class="order-panel">
            <div id="orderItems" class="order-items">
                <p class="empty-msg">No hay productos seleccionados</p>
            </div>
            <div class="order-footer">
                <div class="total-row">
                    <span>TOTAL:</span>
                    <span id="totalDisplay">$0</span>
                </div>
                <button class="btn-print" onclick="abrirCheckout()">FINALIZAR PEDIDO</button>
            </div>
        </aside>
    </div>


   <div id="modal-checkout" class="modal-overlay" style="display:none;">
    <div class="modal-content checkout-container" style="max-width:500px;">
        <h3>Finalizar Pedido</h3>
        <div class="form-grid">
            <input type="tel" id="clienteTelefono" placeholder="Teléfono / WhatsApp" maxlength="10">
            <input type="text" id="clienteNombre" placeholder="Nombre Cliente">           
            <input type="text" id="clienteDireccion" placeholder="Dirección Completa" class="full-width">
            <select id="metodoPago" class="full-width">
                <option value="" disabled selected>Método de Pago</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Nequi/Daviplata">Nequi / Daviplata</option>
                <option value="Datafono">Datáfono</option>
            </select>
            <textarea id="observaciones" placeholder="Observaciones..." class="full-width"></textarea>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="cerrarCheckout()" class="btn-cancelar">Volver</button>
            <button onclick="procesarPedidoFinal()" class="btn-print">IMPRIMIR TICKET</button>
        </div>
    </div>
</div>
</div>
    <div id="modal-seleccion" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3 id="modal-titulo">Seleccionar Tamaño</h3>
            <div id="opciones-tamano" class="opciones-grid"></div>
            <button onclick="cerrarModal()" class="btn-cancelar">Cerrar</button>
        </div>
    </div>
    <script src="products.js"></script>      
    <script src="app.js"></script>
    
    <script type="module">
    // 1. Importamos la base (App) y la base de datos (Firestore)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp , doc, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // 2. Tus credenciales NUEVAS de Molle Pizza
    const firebaseConfig = {
        apiKey: "AIzaSyAlyIoXRLMr0i20qU6dMkQDTSWotEht3T0",
        authDomain: "mollepizza-f05d8.firebaseapp.com",
        projectId: "mollepizza-f05d8",
        storageBucket: "mollepizza-f05d8.firebasestorage.app",
        messagingSenderId: "639672533177",
        appId: "1:639672533177:web:dcef1c044b320bb89adb68"
    };

    // 3. Inicializamos los servicios
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app); // <--- ¡Esto es lo que faltaba!

    // 4. Creamos la función "puente" para que tu app.js pueda guardar datos
    // Dentro de tu script en index.html
window.enviarAFirebase = async (datosPedido) => {
    // Debe coincidir exactamente con tu imagen: "contadores" y "ultimoIdPedidos"
    const contadorRef = doc(db, "contadores", "ultimoIdPedidos");

    try {
        const nuevoNumeroPedido = await runTransaction(db, async (transaction) => {
            const contadorDoc = await transaction.get(contadorRef);
            
            if (!contadorDoc.exists()) {
                throw "El documento de contador no existe en Firebase";
            }

            const nuevoId = contadorDoc.data().ultimoId + 1;
            
            // Actualizamos el contador en la base de datos
            transaction.update(contadorRef, { ultimoId: nuevoId });
            return nuevoId;
        });

        // Guardamos el pedido incluyendo el nPedido consecutivo
        const docRef = await addDoc(collection(db, "pedidos"), {
            ...datosPedido,
            nPedido: nuevoNumeroPedido, 
            fecha: serverTimestamp(),
            estado: "pendiente"
        });

        return nuevoNumeroPedido; 
    } catch (error) {
        console.error("Error en la secuencia del contador:", error);
        throw error;
    }
};
</script>
    
</body>
</html>